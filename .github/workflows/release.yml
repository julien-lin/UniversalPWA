name: Release - Production Deployment

on:
  push:
    tags:
      - "v*" # D√©clenche sur tags version (v1.0.0, v2.0.0, etc.)

jobs:
  validate:
    name: Pre-Release Validation (MANDATORY)
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clear TypeScript cache
        run: |
          rm -rf packages/*/tsconfig.tsbuildinfo
          rm -rf packages/*/.tsbuildinfo
          find packages -name "*.tsbuildinfo" -delete || true

      # === MANDATORY: All three must pass before release ===

      - name: "‚úÖ Step 1/3: Lint (pnpm -r lint)"
        run: pnpm -r lint
        continue-on-error: false

      - name: "‚úÖ Step 2/3: Typecheck (pnpm -r typecheck)"
        run: pnpm -r typecheck
        continue-on-error: false

      - name: "‚úÖ Step 3/3: Test + Coverage (pnpm -r test)"
        run: pnpm -r --filter '!universal-pwa-demos' test
        continue-on-error: false

  build-and-release:
    name: Build & Publish to npm
    runs-on: ubuntu-latest
    needs: validate # Only if validation passes
    if: github.ref_type == 'tag' && startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Clear TypeScript cache
        run: |
          rm -rf packages/*/tsconfig.tsbuildinfo
          rm -rf packages/*/.tsbuildinfo
          find packages -name "*.tsbuildinfo" -delete || true

      - name: Build all packages
        run: pnpm -r build

      - name: Verify build artifacts
        run: |
          echo "=== Verifying build artifacts ==="
          packages_to_check=("core" "cli" "templates" "web-ui")
          all_ok=true
          for pkg in "${packages_to_check[@]}"; do
            if [ ! -d "packages/$pkg/dist" ]; then
              echo "‚ùå FAILED: packages/$pkg/dist not found!"
              all_ok=false
            else
              size=$(du -sh packages/$pkg/dist | cut -f1)
              echo "‚úÖ packages/$pkg/dist exists ($size)"
            fi
          done
          if [ "$all_ok" = false ]; then
            exit 1
          fi

      - name: Security audit (production deps only)
        run: |
          echo "=== Running security audit ==="
          pnpm audit --prod || {
            echo "‚ö†Ô∏è  Vulnerabilities found - review above"
            # Don't fail release on audit, just warn
          }

      - name: Publish to npm
        run: |
          echo "=== Publishing packages to npm ==="
          pnpm --filter @julien-lin/universal-pwa-core publish --access public --no-git-checks || {
            echo "‚ö†Ô∏è  Core already published or error occurred"
          }
          pnpm --filter @julien-lin/universal-pwa-cli publish --access public --no-git-checks || {
            echo "‚ö†Ô∏è  CLI already published or error occurred"
          }
          pnpm --filter @julien-lin/universal-pwa-templates publish --access public --no-git-checks || {
            echo "‚ö†Ô∏è  Templates already published or error occurred"
          }
          pnpm --filter @julien-lin/universal-pwa-web-ui publish --access public --no-git-checks || {
            echo "‚ö†Ô∏è  Web UI already published or error occurred"
          }
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        continue-on-error: false

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "Release ${{ github.ref_name }}"
          body: |
            ## Release ${{ github.ref_name }}

            ‚úÖ **Validation Status**: All checks passed (lint, typecheck, test)  
            üì¶ **Published Packages**:
            - @julien-lin/universal-pwa-core
            - @julien-lin/universal-pwa-cli
            - @julien-lin/universal-pwa-templates
            - @julien-lin/universal-pwa-web-ui

            ### Engineering Rules Applied
            - ‚úÖ Lint: 100% pass
            - ‚úÖ Typecheck: 100% pass
            - ‚úÖ Tests: 100% pass
            - ‚úÖ Build artifacts verified
            - ‚úÖ Bundle size <500KB (core)

            For details, see `.github/ENGINEERING_RULES.md`
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        if: always()
        run: |
          echo "=== RELEASE SUMMARY ==="
          echo "Release: ${{ github.ref_name }}"
          echo "Validation: PASSED ‚úÖ"
          echo "Publishing: COMPLETE"
          echo "See .github/ENGINEERING_RULES.md for validation details"
